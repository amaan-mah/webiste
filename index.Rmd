---
title: "Project"
author: "Mohammed Hussain"
output: 
  html_document:
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include=FALSE, error=FALSE}
library(readxl)
library(tidyverse)
library(factoextra)
library(sf)
library(lwgeom)
library(plotly)
library(leaflet)
```

```{r zip, include=FALSE}
zip_shp <- st_read("C:/Users/amaan/Desktop/Project/GIS/ZIP_Codes_in_Durham_County/ZIP_Codes_in_Durham_County.shp", quiet = TRUE)
zip_shp <- st_transform(zip_shp, 32119)
```
```{r road, include=FALSE}
road_shp <- st_read("C:/Users/amaan/Desktop/Project/GIS/Roads/Roads.shp",quiet = TRUE)
road_shp <- st_transform(road_shp, 32119)
```

![The region of interest mapped in research articles](C:/Users/amaan/Desktop/Project/website/GIS Data & Code/Region.png)

I will map this approximate region using ZIP code region and roads data available on Durham Open Data Portal. The region covers parts of the four ZIP code regions: 27701,27703,27704,27707. The region is bounded by four highways: 15/501,85,885,147.

I ran into a lot of trouble trying to combine roads and cut boundaries with the ZIP code regions. I was trying to make a boundary with the four highways but the individual data points for the roads were numerous to combine into one line string or multi-string. I decided to manually plot four points and connect them as a polygon to mark the region of interest. Then it was easier to intersect the ZIP code regions and roads to focus on the region of interest. I learned that manually plotting points is not uncommon for such a task.

```{r boundaries}
# The boundaries can be manually created using estimated coordinates
cut_poly <- 
  st_polygon(
    list(
      rbind(
        c(-78.90, 36.02),  # NW
        c(-78.86, 36.02),  # NE
        c(-78.86, 35.96),  # SE
        c(-78.90, 35.96),  # SW
        c(-78.90, 36.02)
          )
        )
      )
```


```{r region_map, include=FALSE}

# The region of interest extends into three ZIP code regions
zips_sel <- 
  zip_shp |>
  filter(ZIPCODE %in% c("27701","27703","27704","27707")) |>
  st_transform(32119)
# The region of interest is bordered by four highways
roads_sel <- 
  road_shp |> 
  filter(HWYNUMBER %in% c("15/501","85","885","147")) |>
  st_transform(32119)

# The boundaries can be manually created using estimated coordinates
cut_poly <- st_polygon(list(rbind(
  c(-78.90, 36.02),  # NW
  c(-78.86, 36.02),  # NE
  c(-78.86, 35.96),  # SE
  c(-78.90, 35.96),  # SW
  c(-78.90, 36.02)
)))
cut_poly <- st_sfc(cut_poly, crs = 4326)
cut_poly <- st_transform(cut_poly, st_crs(roads_sel))
# The ZIP regions and roads can be cutoff to focus on the region of interest
zips_cut <- st_intersection(zips_sel, cut_poly)
roads_cut <- st_intersection(roads_sel, cut_poly)

zips_cut    <- st_transform(zips_cut, 4326)
roads_cut  <- st_transform(roads_cut, 4326)
cut_poly  <- st_transform(cut_poly, 4326)

durham <- zip_shp |> filter(CITY == "DURH")
  # # Base region
  # addPolygons(
  #   data = durham,
  #   fillColor = "#e5ecf6",
  #   fillOpacity = 0.6,
  #   color = "#2b2b2b",
  #   weight = 1
  # ) %>%

```


```{r base}

base <- 
  leaflet(options = leafletOptions(preferCanvas = TRUE)) |>
  addProviderTiles(providers$Esri) |>
  # ZIP code regions
  addPolygons(
    data = zips_cut,
    fill = FALSE,
    color = "brown",
    weight = 0.5,
    opacity = 0.6
  ) |>
  # Roads
  addPolylines(
    data = roads_cut,
    color = "black",
    weight = 1,
    opacity = 0.7
  ) |>
  # Region of interest
  addPolygons(
    data = cut_poly,
    fill = FALSE,
    color = "red",
    weight = 2,
    dashArray = "5,5"
  )
base

```

## EPA Data Analysis

The previous studies have observed the Cadmium concentrations in water and soil and did not find a significant correlation with the blood Cadmium levels. However, there were no measurements of Cadmium in the air and considering that the Durham county has quite a few industries, it is worth checking the EPA data for emissions in general.

```{r epa_data_cleaning, include=FALSE}

epa_df <- read_csv("C:/Users/amaan/Desktop/Project/website/GIS_Data_Code/EPA_2023_nc.csv", col_names = TRUE)

epa_durham <-
  epa_df |>
  rename(
    "Facility_Name" = "4. FACILITY NAME",
    "Street_Address" = "5. STREET ADDRESS",
    "City" = "6. CITY",
    "County" = "7. COUNTY",
    "ZIP" = "9. ZIP",
    "Latitude" = "12. LATITUDE",
    "Longitude" = "13. LONGITUDE",
    "Industry" = "23. INDUSTRY SECTOR",
    "Chemical" = "37. CHEMICAL",
    "Unit" = "50. UNIT OF MEASURE",
    "Fugitive_Air" = "51. 5.1 - FUGITIVE AIR",
    "Stack_Air" = "52. 5.2 - STACK AIR",
    "Water" = "53. 5.3 - WATER",
    "Underground" = "54. 5.4 - UNDERGROUND",
    "Total_On_Site" = "65. ON-SITE RELEASE TOTAL"
  ) |>
  filter(City == "DURHAM") |>
  arrange(desc(Total_On_Site)) |>
  select(
    Chemical,Facility_Name,
    Unit,Total_On_Site,Fugitive_Air,Stack_Air,Water,Underground,
    Industry,ZIP,Street_Address,Longitude,Latitude
    )

```

`head(epa_durham,10)`

None of the emissions are Cadmium and Cadmium compounds.

However, it is still worth observing the emissions in the region of interest because it leads to air pollution and detrimental health.
The measurements for all emissions are in pounds here which allows for easy comparison.

The facilities mostly have emissions under stack air which means the emissions are released through controlled airways, but Brenntag Mid-South mostly has emissions under fugitive air which means the emissions are leaked unintentionally and possibly due to faulty equipment.

No emissions are released into the water or underground which matches the findings from the study a decade ago when no significant associations were found between Cadmium blood levels and Cadmium concentrations in water and soil, and possibly demonstrates that the finding still holds in the present as no emissions are released into the water or underground. 

```{r epa_data_anlaysis, include=FALSE}

epa_locations <-
  epa_durham |>
  group_by(Facility_Name,ZIP,Longitude,Latitude) |>
  summarize(Total_Emissions=sum(Total_On_Site),.groups="drop") |>
  arrange(desc(Total_Emissions)) |>
  filter(Total_Emissions > 100)
epa_locations

# The region of interest is partially in the ZIP region 27703. 
# The region has the most facilities and 3 of the facilities with the highest total emissions.

```

A lot of the facilities with emissions are in the ZIP code regions covered by the region of interest. It is worth looking into forming clusters and checking if the cluster of facilities is in the region.

I am used to scaling the data every time before clustering so I was getting unusual results until I realized that scaling is not needed here. For Geolocation data, latitude and longitude have meaningful raw values and an inherent spatial relationship in distance.

```{r epa_data_clustering}

# Select the data for clustering
epa_cluster <- 
  epa_locations |> 
  select(Longitude,Latitude)
# Create the plot to find a suitable k
#* The default for k.max is 10 so set it manually to 4 because the number of clusters must be less than the number of data points for a meaningful clustering.
fviz_nbclust(epa_cluster, kmeans, method = "wss", k.max = 4) +
  labs(title = "Elbow Method Plot")
# K-Means
fit <- kmeans(epa_cluster, centers = 3, iter.max = 50, nstart = 20)
epa_locations$Cluster <- fit$cluster

# Calculate the mean/centroids of each cluster for plotting
epa_k <-
  epa_locations |>
  group_by(Cluster) |>
  summarize(
    Longitude_Center = mean(Longitude),
    Latitude_Center = mean(Latitude)
  ) |>
  select(Cluster,Longitude_Center,Latitude_Center)
epa_k

```

```{r epa_map}

# Create an sf object for plotting
epa_locations_sf <- st_as_sf(epa_k, coords = c("Longitude_Center", "Latitude_Center"), crs = 4269)
epa_locations_sf <- st_transform(epa_locations_sf,st_crs(cut_poly))
# Focus on the clusters in the region of interest
epa_point <- st_intersection(epa_locations_sf,cut_poly)
epa_point <- st_transform(epa_point,4269)

ggplot() +
  geom_sf(data = zips_cut) +
  geom_sf(data = roads_cut, color = "black") +
  geom_sf(data = cut_poly, fill = NA, color = "red", linewidth = 1) +
  geom_sf(data = epa_point, color = "red") +
  geom_sf_label(data = epa_point, aes(label = Cluster)) +
  theme_minimal() +
  coord_sf(datum = NA)

base |>
  addCircleMarkers(
    data = epa_point,
    fill = "red",
    color = "red",
    weight = 5
  )

```

The region of interest contains the center of the cluster of the top facilities in terms of emission. Though Cadmium and Cadmium compounds are not emitted by any facility, some of the other chemicals that are released or leaked have been linked with low birth weight in animals and are a cause for concern for pregnant individuals in general.